<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ä¸Šä¼ å›¾ç‰‡</title>
    <meta name="renderer" content="webkit">
    <link rel="stylesheet" href="../static/css/upload-img.css">
</head>
<body>
<div id="app" class="container" v-cloak>
    <div class="uploading-data" v-if="isUploading"></div>

    <div class="upload-img-column">
        <div class="words">ä¸Šä¼ å›¾ç‰‡ ({{imgTempList.length}}/5)</div>
        <span id="test2" th:text="${session.cNumber}"></span>
        <div class="upload-wrap">
            <div class="box">
                <label class="p dotted">
                    <input type="file" accept="image/jpg,image/jpeg,image/png" name="file"
                           @change="onChooseImage($event)"/>
                    <img src="../static/img/jiahao.png" alt="">
                </label>
            </div>
            <template v-for="(imgItem, imgIndex) in imgTempList">
                <div class="box">
                    <div class="p">
                        <img :src="imgItem">
                        <div class="delete" @click.stop="deleteImg(imgIndex)">
                            <img src="../static/img/guanbi.png" alt="">
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <button class="l-btn" @click="onUploadImg">ä¸Šä¼ </button>

    <!-- å›¾ç‰‡ä¸Šä¼ æˆåŠŸåè¿”å›çš„è·¯å¾„(æ²¡å¿…è¦çš„) -->
    <div class="success-path">
        <template v-for="(item, index) in successPath">
            <a :href="item" target="_blank">{{item}}</a>
        </template>
    </div>

</div>

<script src="../static/js/vue.min.js"></script>
<script src="../static/js/axios.js"></script>
<script th:inline="javascript" type="text/javascript">
    var app = new Vue({
        el: '#app',
        data: {
            imgTempList: [], //å›¾ç‰‡ä¸´æ—¶è·¯å¾„åˆ—è¡¨
            isUploading: false, //æ˜¯å¦æ­£åœ¨ä¸Šä¼ 
            successPath: [], //ä¸Šä¼ æˆåŠŸåçš„è·¯å¾„(æ²¡å¿…è¦)
        },
        mounted: function () {
            var that = this;
        },
        watch: {},
        methods: {
            //é€‰æ‹©å›¾ç‰‡
            onChooseImage: function (event) {
                var that = this;

                //åˆ¤æ–­å›¾ç‰‡æ•°é‡æ˜¯å¦å·²ä¸Šé™
                var currentImgTempArray = that.imgTempList;
                if (currentImgTempArray.length >= 5) {
                    alert("æœ€å¤šä¸Šä¼ 5å¼ å›¾ç‰‡");
                    return false;
                }

                //ä½¿ç”¨FileReaderå¯¹æ–‡ä»¶å¯¹è±¡è¿›è¡Œæ“ä½œ
                var reader = new FileReader();
                reader.readAsDataURL(event.target.files[0]); //å°†è¯»å–åˆ°çš„æ–‡ä»¶ç¼–ç æˆData URL
                reader.onload = function () { //è¯»å–å®Œæˆæ—¶
                    var replaceSrc = reader.result; //æ–‡ä»¶è¾“å‡ºçš„å†…å®¹


                    //è°ƒç”¨å›¾ç‰‡å‹ç¼©å¤„ç†æ–¹æ³•
                    that.compressedImage({
                        src: replaceSrc,
                        quality: 0.8,
                        success: function (src) {
                            //å°†å‹ç¼©åçš„è·¯å¾„ è¿½åŠ åˆ°ä¸´æ—¶è·¯å¾„æ•°ç»„ä¸­
                            var totalList = [];
                            if (currentImgTempArray.length > 0) {
                                totalList = currentImgTempArray.concat(src);
                            } else {
                                totalList[0] = src;
                            }
                            that.imgTempList = totalList;
                        }
                    });
                };

            },

            //åˆ é™¤æŸå¼ å›¾ç‰‡
            deleteImg: function (idx) {
                var that = this;
                that.imgTempList.splice(idx, 1);
            },


            //æäº¤ä¸Šä¼ å›¾ç‰‡
            onUploadImg: function () {
                var that = this;
                var imgTempList = that.imgTempList;
                if (imgTempList.length > 0) {

                    that.isUploading = true; //æ­£åœ¨ä¸Šä¼  æ˜¾ç¤ºé®ç½©å±‚ é˜²æ­¢è¿ç»­ç‚¹å‡»

                    var countNum = 0; //è®¡ç®—æ•°é‡ç”¨çš„ åˆ¤æ–­ä¸Šä¼ åˆ°ç¬¬å‡ å¼ å›¾ç‰‡äº†

                    //mapå¾ªç¯éå†ä¸Šä¼ å›¾ç‰‡
                    imgTempList.map(function (imgItem, imgIndex) {
                        var files = that.dataURLtoFile(imgItem, 'pj' + Date.now() + '.jpg'); //DataURLè½¬File
                        //è¯·æ±‚åå°æ‹¿åˆ°ç‰©å“id

                        //åˆ›FormDataå¯¹è±¡
                        var formdata = new FormData();
                        var cNumber;
                        //append(key,value)åœ¨æ•°æ®æœ«å°¾è¿½åŠ æ•°æ®ã€‚ è¿™å„¿çš„keyå€¼éœ€è¦å’Œåå°å®šä¹‰ä¿æŒä¸€è‡´
                        formdata.append('img', files);
                        axios({
                            method: "POST",
                            url: "http://localhost:9091/getcNumber",
                            data: formdata,
                            headers: {
                                "Content-Type": "multipart/form-data"
                            }
                        }).then(function (res) {
                            cNumber=res.data.cNumber
                            alert(cNumber)
                            //ç”¨axiosä¸Šä¼ ï¼Œ
                            axios({
                                method: "POST",
                                url: "http://localhost:9091/pic/upload/"+cNumber,
                                data: formdata,
                                headers: {
                                    "Content-Type": "multipart/form-data"
                                }
                            }).then(function (res) {
                                countNum++;
                                //å›¾ç‰‡å…¨éƒ¨ä¸Šä¼ å®Œåå»æ‰é®ç½©å±‚
                                if (countNum >= imgTempList.length) {
                                    that.isUploading = false;
                                }

                                if(res.data.success !== ""){
                                    console.log(res.data.success);
                                }
                                else{
                                    console.log(res.data.error);
                                }

                                //æ²¡å¿…è¦çš„ä»£ç  ğŸ‘‡
                                // var list = [];
                                // if (that.successPath.length > 0) {
                                //     list = that.successPath.concat(res.data.url);
                                //     for (var i = 0; i < list.length; i++) {
                                //         console.log(list[i]);
                                //     }
                                // } else {
                                //     list[0] = res.data.path;
                                //     console.log(list[0]);
                                // }
                                // that.successPath = list;

                            }).catch(function (error) {
                                console.error(error);
                            });
                        });

                    });
                }
            },

            /**
             * å‹ç¼©å›¾ç‰‡å¤„ç†
             * @src éœ€è¦å‹ç¼©çš„å›¾ç‰‡base64è·¯å¾„
             * @quality å›¾ç‰‡è´¨é‡ 0-1ï¼Œé»˜è®¤1
             * @success()  æˆåŠŸåçš„å›è°ƒ
             * */
            compressedImage: function (params) {
                var that = this;

                var initParams = {
                    src: params.src || "",
                    quality: params.quality || 1,
                };

                var image = new Image();
                image.src = initParams.src;
                image.onload = function () {
                    //è·å–å›¾ç‰‡åˆå§‹å®½é«˜
                    var width = image.width;
                    var height = image.height;
                    //åˆ¤æ–­å›¾ç‰‡å®½åº¦ï¼Œå†æŒ‰æ¯”ä¾‹è®¾ç½®å®½åº¦å’Œé«˜åº¦çš„å€¼
                    if (width > 1024) {
                        width = 1024;
                        height = Math.ceil(1024 * (image.height / image.width));
                    }

                    //å°†å›¾ç‰‡é‡æ–°ç”»å…¥canvasä¸­
                    var canvas = document.getElementById("compressCanvas");
                    if(!canvas){ //å¦‚æœæ²¡æœ‰å‹ç¼©ç”¨çš„canvas å°±åˆ›å»ºä¸€ä¸ªcanvasç”»å¸ƒ
                        var body = document.body;
                        canvas = document.createElement("canvas"); //åˆ›å»ºcanvasæ ‡ç­¾
                        canvas.id = "compressCanvas"; //ç»™å¤–å±‚å®¹å™¨æ·»åŠ ä¸€ä¸ªid
                        canvas.style.position = "fixed";
                        canvas.style.zIndex = "-1";
                        canvas.style.opacity = "0";
                        canvas.style.top = "-100%";
                        canvas.style.left = "-100%";
                        body.append(canvas);
                    }

                    var context = canvas.getContext("2d");
                    canvas.width = width;
                    canvas.height = height;
                    context.beginPath();
                    context.fillStyle = "#ffffff";
                    context.fillRect(0, 0, width, height);
                    context.fill();
                    context.closePath();
                    context.drawImage(image, 0, 0, width, height);
                    var replaceSrc = canvas.toDataURL("image/jpeg", initParams.quality); //canvasè½¬DataURL(base64æ ¼å¼)

                    params.success && params.success(replaceSrc);
                };
            },

            /**
             * å°†base64è½¬æ¢ä¸ºæ–‡ä»¶
             * @dataUrl base64è·¯å¾„åœ°å€
             * @fileName è‡ªå®šä¹‰æ–‡ä»¶åå­—
             * */
            dataURLtoFile: function (dataUrl, fileName) {
                var arr = dataUrl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new File([u8arr], fileName, {type: mime});
            },
        }
    });
</script>
</body>
</html>
